<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Gift Exchange Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <img src="https://via.placeholder.com/800x300/228B22/FFFFFF?text=Christmas+Tree" alt="Christmas Tree" class="top-image">
        
        <div class="user-info">
            <h2 id="userName"></h2>
            <label for="wishlist">Your Wishlist:</label>
            <textarea id="wishlist" placeholder="Add your gift wishes here..."></textarea>
            <button id="submitWishlist">Submit Wishlist</button>
        </div>
        
        <div class="history-section">
            <button id="historyBtn">Tap to See History of All Users</button>
            <div id="historyList" class="hidden">
                <h3>All Users' Names & Wishlists</h3>
                <div id="userGrid"></div>
            </div>
        </div>
    </div>
    <script type="module">
        import { saveWishlist, loadHistory, loadUserWishlist } from './firebase.js';
        
        console.log("Page2 script loaded.");
        
        // Load current user
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            alert('No user data found. Please register first.');
            window.location.href = 'index.html';
        } else {
            console.log("Current user loaded:", currentUser.name);
        }
        
        document.getElementById('userName').textContent = currentUser.name;
        
        // Check history visibility
        const historyVisible = localStorage.getItem('historyVisible') === 'true';
        const historyList = document.getElementById('historyList');
        if (historyVisible) {
            historyList.classList.remove('hidden');
            console.log("History was visible, showing it.");
        }
        
        // Load user's wishlist on page load
        (async () => {
            console.log("Loading user's wishlist...");
            const wishlist = await loadUserWishlist();
            document.getElementById('wishlist').value = wishlist;
        })();
        
        // Submit wishlist button
        document.getElementById('submitWishlist').addEventListener('click', async function() {
            console.log("Submit wishlist clicked.");
            alert("Submitting wishlist...");
            const wishlistText = document.getElementById('wishlist').value;
            
            const result = await saveWishlist(wishlistText);
            alert(result.message);
        });
        
        // History button
        const historyBtn = document.getElementById('historyBtn');
        historyBtn.addEventListener('click', function() {
            console.log("History button clicked.");
            alert("Toggling history...");
            const isHidden = historyList.classList.contains('hidden');
            if (isHidden) {
                console.log("Showing history.");
                historyList.classList.remove('hidden');
                loadHistory((users) => {
                    const userGrid = document.getElementById('userGrid');
                    userGrid.innerHTML = '';
                    users.forEach(user => {
                        const userCard = document.createElement('div');
                        userCard.className = 'user-card';
                        userCard.innerHTML = `
                            <h4>${user.name}</h4>
                            <p><strong>Wishlist:</strong> ${user.wishlist || 'None yet'}</p>
                        `;
                        userGrid.appendChild(userCard);
                    });
                    alert("History loaded!");
                });
                localStorage.setItem('historyVisible', 'true');
            } else {
                console.log("Hiding history.");
                historyList.classList.add('hidden');
                localStorage.setItem('historyVisible', 'false');
            }
        });
    </script>
</body>
</html>
